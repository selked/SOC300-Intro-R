#Set Working Directory
setwd("C:/Users/Daulton/Downloads")
setwd("C:/Users/selke/Desktop/Scholarship/USAJobs Project")

#Read in the data
load("ja_cskills.rda")
load("ja_recoded.rda")

#Load some packages
library(ggplot2)
library(flextable)
library(huxtable)
library(magrittr)
library(dplyr)
#install.packages("mediation")
library(mediation)
#install.packages('furrr')
library(furrr)
install.packages('lmerTest')

workingjobs.df<-ja_recoded

workingjobs.df$age_square<-workingjobs.df$ageu^2

names(workingjobs.df)[38]

workingjobs.df <- workingjobs.df %>%
  group_by(soccode) %>%
  mutate(other.race=nhpiu+nhnau)

names(workingjobs.df)[136]<-"care_index3"

glimpse(workingjobs.df)

ja_recoded<-workingjobs.df

save(ja_recoded, file="ja_recoded.rda")

workingjobs.df<-ja_recoded
names(workingjobs.df)

zscores<-scale(workingjobs.df[,108])



workingjobs.df<-cbind(workingjobs.df, zscores)

names(workingjobs.df)[108]<-"commit_diverse"
names(workingjobs.df)[140]<-"zdiverse"

hist(workingjobs.df$zdiverse)

#Create the Warmth Models
wmodel1<-lm(warmth_dic_hi~femaleu+nhbu+hispu+asianu+other.race+sal_div+jobzone+ageu+age_square+word.count, workingjobs.df)

wmodel2<-lm(warmth_dic_hi~femaleu+nhbu+hispu+asianu+other.race+sal_div+jobzone+ageu+age_square+word.count+care_index3+cog_index2, workingjobs.df)

wmodel3<-lm(warmth_dic_hi~femaleu+nhbu+hispu+asianu+other.race+sal_div+jobzone+ageu+age_square+word.count+care_index3+cog_index2+femaleu:sal_div, workingjobs.df)

wmodel4<-lm(warmth_dic_hi~femaleu+nhbu+hispu+asianu+other.race+sal_div+jobzone+ageu+age_square+zdiverse+word.count+care_index3+cog_index2+femaleu:zdiverse, workingjobs.df)


#Create the Competence Models
cmodel1<-lm(competence_dic_hi~femaleu+nhbu+hispu+asianu+other.race+sal_div+jobzone+ageu+age_square+word.count, workingjobs.df)

cmodel2<-lm(competence_dic_hi~femaleu+nhbu+hispu+asianu+other.race+sal_div+jobzone+ageu+age_square+word.count+care_index3+cog_index2, workingjobs.df)

cmodel3<-lm(competence_dic_hi~femaleu+nhbu+hispu+asianu+other.race+sal_div+jobzone+ageu+age_square+word.count+care_index3+cog_index2+femaleu:sal_div, workingjobs.df)

cmodel4<-lm(competence_dic_hi~femaleu+nhbu+hispu+asianu+other.race+sal_div+jobzone+ageu+age_square+zdiverse+word.count+care_index3+cog_index2+femaleu:zdiverse, workingjobs.df)


#Create list objects for the models so we can use a nested display
wmodels<-list("Model 1" = wmodel1, "Model 2" = wmodel2, "Model 3" = wmodel3, "Model 4" = wmodel4)

cmodels<-list("Model 1" = cmodel1, "Model 2" = cmodel2, "Model 3" = cmodel3, "Model 4" = cmodel4)


#Create a huxreg object for the Warmth Models
wtab<-huxreg(wmodels, statistics = c('N' = "nobs", 'R-squared' = "r.squared"), coefs = c("(Intercept)" ="(Intercept)","Proportion Woman"="femaleu", "Salary"="sal_div", "Cognitive Skills"="cog_index2", "Care Skills"="care_index3", "Percent Woman * Salary"="femaleu:sal_div", "Diversity Commitment"="zdiverse", "Proportion Woman * Diversity Commitment"="femaleu:zdiverse"))%>%
  set_caption("OLS Regressions of Raw Warmth on Vertical and Horizontal Indicators")

#Create a hugreg object for the Competence Models
ctab<-huxreg(cmodels, statistics = c('N' = "nobs", 'R-squared' = "r.squared"), coefs = c("(Intercept)" ="(Intercept)","Proportion Woman"="femaleu", "Salary"="sal_div", "Cognitive Skills"="cog_index2", "Care Skills"="care_index3", "Proportion Woman * Salary"="femaleu:sal_div", "Diversity Commitment"="zdiverse", "Proportion Woman * Diversity Commitment"="femaleu:zdiverse"))%>%
  set_caption("OLS Regressions of Raw Competence on Vertical and Horizontal Indicators")

#Turn these into flextable objects
wtab<-as_flextable(wtab)
ctab<-as_flextable(ctab)

#Take a look at them
wtab
ctab


#Save Warmth tables as a Word doc
save_as_docx(
  "m1" = wtab, "m2" = ctab,
  path = "C:/Users/selke/Desktop/Scholarship/USAJobs Project/flextableszdiverse.docx")

ja_recoded<-workingjobs.df

save(ja_recoded, file="ja_recoded.rda")

load("ja_recoded.rda")

#Save Competence tables as a Word doc
save_as_docx(
  "m2" = ctab,
  path = "C:/Users/selke/Desktop/Scholarship/USAJobs Project/flextablesaccessabilitycompetence.docx")




##############
#Test for causal mediation of the skill variables

#For the warmth models

#Create model estimating effect of IV on the mediator
wfit_mediator<-lm(care_index3~femaleu+nhbu+hispu+asianu+other.race+sal_div+jobzone+ageu+age_square+cog_index2+word.count, workingjobs.df)

summary(wfit_mediator)

#Create model estimating the effect of the mediator on the DV net of other IVs and controls
wfit_dv<-lm(warmth_dic_hi~femaleu+nhbu+hispu+asianu+other.race+sal_div+jobzone+ageu+age_square+word.count+care_index3+cog_index2, workingjobs.df)

summary(wfit_dv)


#Get results

results<-mediate(wfit_mediator, wfit_dv, treat='femaleu', mediator = 'care_index3', boot=T)

summary(wresults)

plot(wresults)

#For the Competence Models
#Create model estimating effect of IV on the mediators
cfit_mediator1<-lm(cog_index2~femaleu+nhbu+hispu+asianu+other.race+sal_div+jobzone+ageu+age_square+care_index3+word.count, workingjobs.df)

cfit_mediator2<-lm(care_index3~femaleu+nhbu+hispu+asianu+other.race+sal_div+jobzone+ageu+age_square+cog_index2+word.count, workingjobs.df)

summary(cfit_mediator1)
summary(cfit_mediator1)


#Create model estimating the effect of the mediator net of other IVs and controls
cfit_dv<-lm(competence_dic_hi~femaleu+nhbu+hispu+asianu+other.race+sal_div+jobzone+ageu+age_square+word.count+care_index3+cog_index2, workingjobs.df)



summary(cfit_dv)

#Get results
cresults<-mediate(cfit_mediator1, cfit_dv, treat='femaleu', mediator = 'cog_index2', boot=T)

cresults2<-mediate(cfit_mediator2, cfit_dv, treat='femaleu', mediator = 'care_index3', boot=T)


summary(cresults)
summary(cresults2)

plot(cresults)
plot(cresults2)


########
##Test for significant changes across models using seemingly unrelated regression estimation (SUR)

install.packages("clubSandwich")
library(clubSandwich)
install.packages("systemfit")
library(systemfit)
install.packages("sur")
library(sur)


#Model equations
weq1<-warmth_dic_hi~femaleu+nhbu+hispu+asianu+other.race+sal_div+jobzone+ageu+age_square+word.count

weq2<-warmth_dic_hi~femaleu+nhbu+hispu+asianu+other.race+sal_div+jobzone+ageu+age_square+word.count+care_index3+cog_index2


equations<-list(weq1, weq2)
sur_model<-systemfit(list(womanreg=weq1, skillreg=weq2), data=workingjobs.df)

summary(sur_model)

restriction <- "womanreg_femaleu- skillreg_femaleu"
linearHypothesis(sur_model, restriction, test = "Chisq")


compareCoefs(wmodel1, wmodel2, zvals=TRUE, pvals=TRUE, print=TRUE)

install.packages("paramhetero")
library(paramhetero)


compare_coefs(models)


######Plot the model coefficients
library(tidyverse) # always bring in the tidy tools
library(haven) # to read in Stata .dta files
library(jtools) # contains the plotting procedures
library(broom.mixed) # separate package called on by plot_coefs
#install.packages('ggstance')
library(ggstance)
#update.packages('ggplot')
library(magrittr)

#Plot Warmth Model Coefficients

plot_coefs(wmodel1, wmodel2,
           coefs = c("Proportion Women" = "femaleu","Cognitive Skills" = "cog_index2", "Care Skills" = "care_index3"),
           scale = FALSE, # generates standardized coefficients when TRUE
           robust = FALSE, # robust standard errors when TRUE
           legend.title = "Predicted Warmth Language",
           model.names = c("Without Gendered Skills","With Gendered Skills")) 

plot_coefs(wmodel1, wmodel2,
           coefs = c("Salary" = "sal_div"),
           scale = FALSE, # generates standardized coefficients when TRUE
           robust = FALSE, # robust standard errors when TRUE
           legend.title = "Predicted Warmth Language",
model.names = c("Without Gendered Skills","With Gendered Skills")) 



#Plot Competence Model Coefficients
plot_coefs(cmodel1, cmodel2,
           coefs = c("Proportion Women" = "femaleu","Cognitive Skills" = "cog_index2", "Care Skills" = "care_index3"),
           scale = FALSE, # generates standardized coefficients when TRUE
           robust = FALSE, # robust standard errors when TRUE
           legend.title = "Predicted Competence Language",
           model.names = c("Without Gendered Skills","With Gendered Skills")) 

plot_coefs(cmodel1, cmodel2,
           coefs = c("Salary" = "sal_div"),
           scale = FALSE, # generates standardized coefficients when TRUE
           robust = FALSE, # robust standard errors when TRUE
           legend.title = "Predicted Competence Language",
           model.names = c("Without Gendered Skills","With Gendered Skills")) 



####Descriptives
warmth<-ja_recoded$warmth_dic_hi

mean(ja_recoded$warmth_dic_hi)
sd(warmth)
min(warmth)
max(warmth)

competence<-ja_recoded$competence_dic_hi
mean(competence)
sd(competence)
min(competence)
max(competence)

fem<-ja_recoded$femaleu
mean(fem)
sd(fem)
min(fem)
max(fem)

sal<-ja_recoded$sal_div
mean(sal)
sd(sal)
min(sal)
max(sal)

cog<-ja_recoded$cog_index2
mean(cog)
sd(cog)
min(cog)
max(cog)

care<-ja_recoded$care_index3
mean(care)
sd(care)
min(care)
max(care)

nas<-ja_recoded[complete.cases(ja_recoded)]

ja_nona<-complete.cases()

options(scipen = 0)

divcom <- ja_recoded$zdiverse
mean(divcom, na.rm=TRUE)
sd(divcom, na.rm=TRUE)
min(divcom, na.rm=TRUE)
max(divcom, na.rm=TRUE)

dico<-ja_recoded$commit_diverse
mean(dico, na.rm=TRUE)
sd(dico, na.rm=TRUE)
min(dico, na.rm=TRUE)
max(dico, na.rm=TRUE)

white<-ja_recoded$whiteu
mean(white)
sd(white)
min(white)
max(white)

aa<-ja_recoded$blacku
mean(aa)
sd(aa)
min(aa)
max(aa)

hisp<-ja_recoded$hispu
mean(hisp)
sd(hisp)
min(hisp)
max(hisp)

azn<-ja_recoded$asianu
mean(azn)
sd(azn)
min(azn)
max(azn)

othr<-ja_recoded$other.race
mean(othr)
sd(othr)
min(othr)
max(othr)

jz<-ja_recoded$jobzone
mean(jz)
sd(jz)
min(jz)
max(jz)

age<-ja_recoded$ageu
mean(age)
sd(age)
min(age)
max(age)

agsq<-ja_recoded$age_square
mean(agsq)
sd(agsq)
min(agsq)
max(agsq)

wc<-ja_recoded$word.count
mean(wc)
sd(wc)
min(wc)
max(wc)



####Brainstorming warmth/competence prop
workingjobs.df$warmth_prop<-workingjobs.df$warmth_dic_hi/workingjobs.df$word.count

workingjobs.df$competence_prop<-workingjobs.df$competence_dic_hi/workingjobs.df$word.count

workingjobs.df$warmth_prop<-workingjobs.df$warmth_prop*100

workingjobs.df$competence_prop<-workingjobs.df$competence_prop*100


#Create the Warmth Models
wmodel1<-lm(warmth_prop~femaleu+nhbu+hispu+asianu+other.race+sal_div+jobzone+ageu+age_square+word.count, workingjobs.df)

wmodel2<-lm(warmth_prop~femaleu+nhbu+hispu+asianu+other.race+sal_div+jobzone+ageu+age_square+word.count+care_index3+cog_index2, workingjobs.df)

wmodel3<-lm(warmth_prop~femaleu+nhbu+hispu+asianu+other.race+sal_div+jobzone+ageu+age_square+word.count+care_index3+cog_index2+femaleu:sal_div, workingjobs.df)

wmodel4<-lm(warmth_prop~femaleu+nhbu+hispu+asianu+other.race+sal_div+jobzone+ageu+age_square+zdiverse+word.count+care_index3+cog_index2+femaleu:zdiverse, workingjobs.df)


#Create the Competence Models
cmodel1<-lm(competence_prop~femaleu+nhbu+hispu+asianu+other.race+sal_div+jobzone+ageu+age_square+word.count, workingjobs.df)

cmodel2<-lm(competence_prop~femaleu+nhbu+hispu+asianu+other.race+sal_div+jobzone+ageu+age_square+word.count+care_index3+cog_index2, workingjobs.df)

cmodel3<-lm(competence_prop~femaleu+nhbu+hispu+asianu+other.race+sal_div+jobzone+ageu+age_square+word.count+care_index3+cog_index2+femaleu:sal_div, workingjobs.df)

cmodel4<-lm(competence_prop~femaleu+nhbu+hispu+asianu+other.race+sal_div+jobzone+ageu+age_square+zdiverse+word.count+care_index3+cog_index2+femaleu:zdiverse, workingjobs.df)


#Create list objects for the models so we can use a nested display
wmodels<-list("Model 1" = wmodel1, "Model 2" = wmodel2, "Model 3" = wmodel3, "Model 4" = wmodel4)

cmodels<-list("Model 1" = cmodel1, "Model 2" = cmodel2, "Model 3" = cmodel3, "Model 4" = cmodel4)


#Create a huxreg object for the Warmth Models
wtab<-huxreg(wmodels, statistics = c('N' = "nobs", 'R-squared' = "r.squared"), coefs = c("(Intercept)" ="(Intercept)","Proportion Woman"="femaleu", "Salary"="sal_div", "Cognitive Skills"="cog_index2", "Care Skills"="care_index3", "Percent Woman * Salary"="femaleu:sal_div", "Diversity Commitment"="zdiverse", "Proportion Woman * Diversity Commitment"="femaleu:zdiverse"))%>%
  set_caption("OLS Regressions of Raw Warmth on Vertical and Horizontal Indicators")

#Create a hugreg object for the Competence Models
ctab<-huxreg(cmodels, statistics = c('N' = "nobs", 'R-squared' = "r.squared"), coefs = c("(Intercept)" ="(Intercept)","Proportion Woman"="femaleu", "Salary"="sal_div", "Cognitive Skills"="cog_index2", "Care Skills"="care_index3", "Proportion Woman * Salary"="femaleu:sal_div", "Diversity Commitment"="zdiverse", "Proportion Woman * Diversity Commitment"="femaleu:zdiverse"))%>%
  set_caption("OLS Regressions of Raw Competence on Vertical and Horizontal Indicators")

#Turn these into flextable objects
wtab<-as_flextable(wtab)
ctab<-as_flextable(ctab)

#Take a look at them
wtab
ctab

sd(workingjobs.df$warmth_prop)

summary(workingjobs.df$warmth_dic_hi)


warmy<-subset(workingjobs.df, warmth_dic_hi>60)

warmy$duties


library(qpdf)

setwd("C:/Users/selke/Downloads")

pdf_combine(input=c("phon1.pdf", "phon2.pdf"), output="Ch3.pdf")
